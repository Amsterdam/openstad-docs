# Getting started

The easiest way to get started with a development environment is to use docker-compose. An alternative is to install and configure all the server seperately, see the  (see the architecture section for this). This section will focus on docker-compose.

Status: WIP

Prerequisites:
- Docker

## 1. Checkout openstad-app
We've bundled our 5 nodejs servers in one git Repo openstad-app with git submodules. Be aware submodules in GIT work a bit different then regular git commits.

https://github.com/Amsterdam/openstad-app

After checking out the repo, the git submodules need to be pulled seperately, this is one way of doing that:

```
git submodule update --init --recursive
```

## 2. Create .env file before starting docker-compose
First create the .env before running docker-compose the first time. There is an .env.example in openstad-app repo..

On first startup docker compose will create the databases, changes to name of the database first startup you have to manually do them by logging into mysql through shell or a db tool like sqlpro, or just destroy the database volumes and start over. This step only makes sure the databases exists, the tables filling the databases are created in the next step.

Create a .env file based upon the .env for development, put it in the root next to docker-compose. This will run the CMS as http://localhost:4444/. Login token will be generated by following env value: AUTH_FIRST_CLIENT_LOGIN_CODE


## Start up docker compose
For development install and start docker desktop.

```
docker-compose up --d
```

## Running migrations and seeds
For now, for dev, the migrations have to be run manually.

There are a few settings in the databases that need to be set correctly for it all
to work together. This works in combination with above .env values.
Any changes in .env values after running the seeds might require database changes.


1. Create the api site entries (runs both basic migrations and seeds.). This seed run will empty the tables, so don't use once running.
```
docker-compose exec api node reset.js
```

2.1 Create the tables for the Auth server
```
docker-compose exec auth knex migrate:latest
```

2.2 Seed the table for the Auth server. . This seed run will empty the tables, so don't use once running.
```
docker-compose exec auth knex seed:run
```

3.1 Create the tables for the Image server
```
docker-compose exec image knex migrate:latest
```

3.2 Seed the tables for the Image server. This seed run will empty the tables, so don't use once running.
```
docker-compose exec image knex seed:run
```

## Mysql
Docker compose creates the databases set in .env file on first run.
If name is changed you will either have to recreate the mysql volume, or manually change or add the database.
Port 3310 is open, so you can access docker database on http://localhost:3310, for instance with sqlpro.
Or log into the docker shell: docker-compose exec mysql sh

## Reloading .env values
docker-compose doesn't always seem to reload env values if you change the .env file.

To force it:

For all containers:
docker-compose up --force-recreate

For one container
docker-compose up --force-recreate frontend
